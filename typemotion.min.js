(function(b){b(function(){var n=b("p"),s=!1,k=null,y=0,z=0,p={position:"absolute",margin:0,padding:"10px",background:"#242424",border:"1px solid rgba(255,255,255,.3)","border-radius":"10px",padding:"10px 15px",color:"#fff","font-size":"18px","font-family":"tahoma","z-index:":15E3},t={"font-size":"18px","font-weight":"normal",padding:0,"margin-top":"25px",color:"#fff","margin-bottom":"5px"},d={padding:0,margin:0,"list-style":"none","font-size":"15px"},f=b("<div>");f.css(b.extend({},p,{"text-align":"center"})); f.hide();var c=b("<div>");c.css(p);var A=b("<h1>").html("TypeMotion").css({"font-weight":"normal","font-size":"26px",margin:"0 0 10px",cursor:"move",color:"#fff",display:"inline-block"}),e=b("<h2>").html("Measure").css(b.extend({},t,{"margin-top":0})),t=b("<h2>").html("Vertical Rythm").css(t);c.append(A).append(e);var e=b("<li>").css({"margin-bottom":"3px","list-style":"none"}),q=b("<ul>").css(d);q.append(e.clone().html('<label>Average :</label> <span class="tm-average"></span>'));q.append(e.clone().html('<label>Minimum :</label> <span class="tm-min"></span>')); q.append(e.clone().html('<label>Maximum :</label> <span class="tm-max"></span>'));q.append(e.clone().html('<label>Total signs :</label> <span class="tm-signs"></span>'));c.append(q);d=b("<ul>").css(d);d.append(e.clone().html('<label for="tm-fontsize">Font size :</label><input id="tm-fontsize" data-prop="font-size" type="text" />'));d.append(e.clone().html('<label for="tm-lineheight">Line height :</label><input id="tm-lineheight" data-prop="line-height" type="text" />'));d.append(e.clone().html('<label for="tm-wordspacing">Word spacing :</label><input id="tm-wordspacing" data-prop="word-spacing" type="text" />')); d.append(e.clone().html('<label for="tm-letterspacing">Letter spacing :</label><input id="tm-letterspacing" data-prop="letter-spacing" type="text" />'));c.append(t);c.append(d);c.find("label").css({"min-width":"100px",display:"inline-block",color:"#fff"});c.hide();var r=b("<div>");r.css(b.extend({},p,{position:"fixed",top:10,right:10,cursor:"pointer","text-align":"center"}));r.html("Exit TypeMotion");b("body").append(f).append(r).append(c);p=b("#tm-fontsize, #tm-lineheight, #tm-wordspacing, #tm-letterspacing"); p.css({width:"70px","text-align":"right","margin-left":"20px","margin-right":"5px",padding:"6px 4px",color:"#fff",background:"rgba(0,0,0,.8)",border:"1px solid #222","border-radius":"4px"});b.fn.spanify=function(a){this.each(function(){if(3===this.nodeType){var g=b("<div>");b.each(this.data.split(/\s/),function(c,m){m.length&&g.append(b(a).clone().text(m+" "))});b(this).after(g.html()).remove()}else b(this.childNodes).spanify(a)})};var v="tm"+(new Date).getTime();n.spanify(b("<span>").addClass(v)); var B=function(){var a=b(this);escape(a.text());var a=a.find("span."+v),g=a.first().offset().top,c=[];a.each(function(a){var d=b(this).offset().top;d>g&&(g=d,c.push(a))});var m=[],e=0,h="";a.each(function(a){if(a<c[e])h+=this.textContent+" ";else{if(e>=c.length)return!1;m.push(h.substring(0,h.length-1).replace(/(\t|\n)/g,""));h=(this.innerText||this.textContent)+" ";e++}});for(var a=[],f=0,l=0,d=m.length;l<d;l++)a.push(m[l].length),f+=m[l].length;for(var k=0,l=0,d=a.length;l<d;l++)k+=a[l];l=Math.min.apply(null, a);d=Math.max.apply(null,a);return{measures:a,lines:a.length,average:(k/a.length).toPrecision(4),min:l,max:d,sum:k,signs:f}},u=function(a,g){if(!window.getMatchedCSSRules)return b(a).css(g);var c=a.style.getPropertyValue(g);if(a.style.getPropertyPriority(g))return c;for(var d=getMatchedCSSRules(a),e=d.length;0<e--;){var h=d[e],f=h.style.getPropertyPriority(g);if(null==c||f)if(c=h.style.getPropertyValue(g),f)break}return c||b(a).css(g)},w=function(a){a=B.apply(a);c.find("span.tm-average").html(a.average); c.find("span.tm-min").html(a.min);c.find("span.tm-max").html(a.max);c.find("span.tm-signs").html(a.signs)},x=function(a){f.css({top:a.pageY+5,left:a.pageX+5})},C=function(a){c.css({top:a.pageY-y,left:a.pageX-z})},D=function(a){s||(f.show(),b(this).on("mousemove",x),a=B.apply(this),f.html("average: "+a.average+"<br />min: "+a.min+" \u2014 max: "+a.max))},E=function(a){f.hide();b(this).off("mousemove",x)},F=function(a){if(k!=this){var g=b(this);c.show();c.css({top:g.offset().top,left:g.offset().left+ g.width()});s=!0;k=this;f.hide();b(this).off("mousemove",x);w(this);b("#tm-fontsize").val(u(this,"font-size"));b("#tm-lineheight").val(u(this,"line-height"));b("#tm-wordspacing").val(u(this,"word-spacing"));b("#tm-letterspacing").val(u(this,"letter-spacing"));a.stopPropagation()}};A.mousedown(function(a){var g=c.offset();y=a.pageY-g.top;z=a.pageX-g.left;b(document).on("mousemove",C)}).mouseup(function(){b(document).off("mousemove",C)});p.on("input",function(){var a=this.value.match(/(\d(\.)?)+/g); a&&this.value.substring(0,a[0].length).match(/\.$/)||(b(k).css(this.getAttribute("data-prop"),this.value),w(k))}).on("keydown",function(a){if((40===a.which||38===a.which)&&this.value.match(/-?(\d+)?\.?\d+.?/)){var c=this.value.split(/[^0-9]+$/)[0],d=c.indexOf("."),e=0<=d,f=this.value.substring(c.length),h=e?parseFloat(c):parseInt(c);a=38===a.which?1:-1;e&&(a*=0.1);h=e?(h+a).toFixed(c.length-d-1):h+a;c=this.getAttribute("data-prop");b(k).css(c,h.toString()+f);b(this).val(h.toString()+f);w(k)}});var H= function(a){27==a.which&&G()},I=function(a){!s||(n.has(a.target).length||n.is(a.target)||c.has(a.target).length||c.is(a.target))||(k=null,s=!1,c.hide())},G=function(){b("span."+v).each(function(){b(this.childNodes).unwrap()});n.off("mouseenter",D).off("mouseleave",E).off("click",F);b(document).off("keyup",H).off("click",I);f.remove();c.remove();r.remove()};n.hover(D,E);n.click(F);b(document).on("keyup",H).on("click",I);r.on("click",G)})})(jQuery);