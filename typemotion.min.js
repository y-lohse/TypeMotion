(function(b){b(function(){var l=b("p"),r=!1,k=null,z=0,A=0,f={color:"#fff","font-size":"18px","font-family":"tahoma","font-weight":"normal"},u={position:"absolute",margin:0,padding:"10px 15px",background:"#242424",border:"1px solid rgba(255,255,255,.3)","border-radius":"10px","z-index":15E3},s={"font-size":"18px",padding:0,"margin-top":"25px","margin-bottom":"5px"},g={padding:0,margin:0,"list-style":"none","font-size":"15px"},e=b("<div>");e.css(b.extend({},f,u,{"text-align":"center"}));e.hide();var c= b("<div>");c.css(b.extend({},f,u));var B=b("<h1>").html("TypeMotion").css(b.extend({},f,{"font-size":"26px",margin:"0 0 10px",cursor:"move",display:"inline-block"})),d=b("<h2>").html("Measure").css(b.extend({},f,s,{"margin-top":0})),s=b("<h2>").html("Vertical Rythm").css(b.extend({},f,s));c.append(B).append(d);var d=b("<li>").css({"margin-bottom":"3px","list-style":"none"}),n=b("<ul>").css(b.extend({},f,g));n.append(d.clone().html('<label>Average :</label> <span class="tm-average"></span>'));n.append(d.clone().html('<label>Minimum :</label> <span class="tm-min"></span>')); n.append(d.clone().html('<label>Maximum :</label> <span class="tm-max"></span>'));n.append(d.clone().html('<label>Total signs :</label> <span class="tm-signs"></span>'));c.append(n);g=b("<ul>").css(b.extend({},f,g));g.append(d.clone().html('<label for="tm-fontsize">Font size :</label><input id="tm-fontsize" data-prop="font-size" type="text" />'));g.append(d.clone().html('<label for="tm-lineheight">Line height :</label><input id="tm-lineheight" data-prop="line-height" type="text" />'));g.append(d.clone().html('<label for="tm-margintop">Margin top :</label><input id="tm-margintop" data-prop="margin-top" type="text" />')); g.append(d.clone().html('<label for="tm-marginbottom">Margin bottom :</label><input id="tm-marginbottom" data-prop="margin-bottom" type="text" />'));g.append(d.clone().html('<label for="tm-wordspacing">Word spacing :</label><input id="tm-wordspacing" data-prop="word-spacing" type="text" />'));g.append(d.clone().html('<label for="tm-letterspacing">Letter spacing :</label><input id="tm-letterspacing" data-prop="letter-spacing" type="text" />'));c.append(s);c.append(g);c.find("label").css({"min-width":"130px", display:"inline-block",color:"#fff"});c.hide();var p=b("<div>");p.css(b.extend({},f,u,{position:"fixed",top:10,right:10,cursor:"pointer","text-align":"center"}));p.html("Exit TypeMotion");b("body").append(e).append(p).append(c);var v=b("#tm-fontsize, #tm-lineheight, #tm-margintop, #tm-marginbottom, #tm-wordspacing, #tm-letterspacing");v.css(b.extend({},f,{width:"70px","text-align":"right","font-size":"14px","margin-left":"20px","margin-right":"5px",padding:"6px 4px",background:"rgba(0,0,0,.8)",border:"1px solid #222", "border-radius":"4px"}));b.fn.spanify=function(a){this.each(function(){if(3===this.nodeType){var C=b("<div>");b.each(this.data.split(/\s/),function(m,c){c.length&&C.append(b(a).clone().text(c+" "))});b(this).after(C.html()).remove()}else b(this.childNodes).spanify(a)})};var w="tm"+(new Date).getTime();l.spanify(b("<span>").addClass(w));var D=function(){var a=b(this);escape(a.text());var a=a.find("span."+w),c=a.first().offset().top,m=[];a.each(function(a){var d=b(this).offset().top;d>c&&(c=d,m.push(a))}); 0===m.length&&m.push(a.length-1);var t=[],d=0,q="";a.each(function(a){if(a<m[d])q+=this.textContent+" ";else{if(0<d&&d>=m.length)return!1;t.push(q.substring(0,q.length-1).replace(/(\t|\n)/g,""));q=(this.innerText||this.textContent)+" ";d++}});for(var a=[],g=0,h=0,f=t.length;h<f;h++)a.push(t[h].length),g+=t[h].length;for(var e=0,h=0,f=a.length;h<f;h++)e+=a[h];h=Math.min.apply(null,a);f=Math.max.apply(null,a);return{measures:a,lines:a.length,average:(e/a.length).toPrecision(4),min:h,max:f,sum:e,signs:g}}, x=function(a){a=D.apply(a);c.find("span.tm-average").html(a.average);c.find("span.tm-min").html(a.min);c.find("span.tm-max").html(a.max);c.find("span.tm-signs").html(a.signs)},y=function(a){e.css({top:a.pageY+5,left:a.pageX+5})},E=function(a){c.css({top:a.pageY-z,left:a.pageX-A})},F=function(a){r||(e.show(),b(this).on("mousemove",y),a=D.apply(this),e.html("average: "+a.average+"<br />min: "+a.min+" \u2014 max: "+a.max))},G=function(a){e.hide();b(this).off("mousemove",y)},H=function(a){if(k!=this){a= b(this);c.show();c.css({top:a.offset().top,left:a.offset().left+a.width()});r=!0;k=this;e.hide();b(this).off("mousemove",y);x(this);var d=this;v.each(function(){var a;a=b(this).data("prop");if(window.getMatchedCSSRules){var c=d.style.getPropertyValue(a);if(d.style.getPropertyPriority(a))a=c;else{for(var f=getMatchedCSSRules(d)||[],g=f.length;0<g--;){var e=f[g],h=e.style.getPropertyPriority(a);if(null==c||h)if(c=e.style.getPropertyValue(a),h)break}a=c||b(d).css(a)}}else a=b(d).css(a);this.value=a})}}; B.mousedown(function(a){var d=c.offset();z=a.pageY-d.top;A=a.pageX-d.left;b(document).on("mousemove",E)}).mouseup(function(){b(document).off("mousemove",E)});v.on("input",function(){var a=this.value.match(/(\d(\.)?)+/g);a&&this.value.substring(0,a[0].length).match(/\.$/)||(b(k).css(this.getAttribute("data-prop"),this.value),x(k))}).on("keydown",function(a){if((40===a.which||38===a.which)&&this.value.match(/-?(\d+)?\.?\d+.?/)){var c=this.value.split(/[^0-9]+$/)[0],d=c.indexOf("."),f=0<=d,g=this.value.substring(c.length), e=f?parseFloat(c):parseInt(c);a=38===a.which?1:-1;f&&(a*=0.1);e=f?(e+a).toFixed(c.length-d-1):e+a;c=this.getAttribute("data-prop");b(k).css(c,e.toString()+g);b(this).val(e.toString()+g);x(k)}});var J=function(a){27==a.which&&I()},K=function(a){!r||(l.has(a.target).length||l.is(a.target)||c.has(a.target).length||c.is(a.target))||(k=null,r=!1,c.hide())},I=function(){b("span."+w).each(function(){b(this.childNodes).unwrap()});l.off("mouseenter",F).off("mouseleave",G).off("click",H);b(document).off("keyup", J).off("click",K);e.remove();c.remove();p.remove()};l.hover(F,G);l.click(H);b(document).on("keyup",J).on("click",K);p.on("click",I)})})(jQuery);