(function(b){b(function(){var p=b("p"),t=!1,m=null,z=0,A=0,g={color:"#fff","font-size":"18px","font-family":"tahoma","font-weight":"normal"},q={position:"absolute",margin:0,padding:"10px 15px",background:"#242424",border:"1px solid rgba(255,255,255,.3)","border-radius":"10px","z-index:":15E3},u={"font-size":"18px",padding:0,"margin-top":"25px","margin-bottom":"5px"},e={padding:0,margin:0,"list-style":"none","font-size":"15px"},d=b("<div>");d.css(b.extend({},g,q,{"text-align":"center"}));d.hide(); var c=b("<div>");c.css(b.extend({},g,q));var B=b("<h1>").html("TypeMotion").css(b.extend({},g,{"font-size":"26px",margin:"0 0 10px",cursor:"move",display:"inline-block"})),f=b("<h2>").html("Measure").css(b.extend({},g,u,{"margin-top":0})),u=b("<h2>").html("Vertical Rythm").css(b.extend({},g,u));c.append(B).append(f);var f=b("<li>").css({"margin-bottom":"3px","list-style":"none"}),r=b("<ul>").css(b.extend({},g,e));r.append(f.clone().html('<label>Average :</label> <span class="tm-average"></span>')); r.append(f.clone().html('<label>Minimum :</label> <span class="tm-min"></span>'));r.append(f.clone().html('<label>Maximum :</label> <span class="tm-max"></span>'));r.append(f.clone().html('<label>Total signs :</label> <span class="tm-signs"></span>'));c.append(r);e=b("<ul>").css(b.extend({},g,e));e.append(f.clone().html('<label for="tm-fontsize">Font size :</label><input id="tm-fontsize" data-prop="font-size" type="text" />'));e.append(f.clone().html('<label for="tm-lineheight">Line height :</label><input id="tm-lineheight" data-prop="line-height" type="text" />')); e.append(f.clone().html('<label for="tm-wordspacing">Word spacing :</label><input id="tm-wordspacing" data-prop="word-spacing" type="text" />'));e.append(f.clone().html('<label for="tm-letterspacing">Letter spacing :</label><input id="tm-letterspacing" data-prop="letter-spacing" type="text" />'));c.append(u);c.append(e);c.find("label").css({"min-width":"100px",display:"inline-block",color:"#fff"});c.hide();var s=b("<div>");s.css(b.extend({},g,q,{position:"fixed",top:10,right:10,cursor:"pointer","text-align":"center"})); s.html("Exit TypeMotion");b("body").append(d).append(s).append(c);q=b("#tm-fontsize, #tm-lineheight, #tm-wordspacing, #tm-letterspacing");q.css(b.extend({},g,{width:"70px","text-align":"right","margin-left":"20px","margin-right":"5px",padding:"6px 4px",background:"rgba(0,0,0,.8)",border:"1px solid #222","border-radius":"4px"}));b.fn.spanify=function(a){this.each(function(){if(3===this.nodeType){var k=b("<div>");b.each(this.data.split(/\s/),function(c,n){n.length&&k.append(b(a).clone().text(n+" "))}); b(this).after(k.html()).remove()}else b(this.childNodes).spanify(a)})};var w="tm"+(new Date).getTime();p.spanify(b("<span>").addClass(w));var C=function(){var a=b(this);escape(a.text());var a=a.find("span."+w),k=a.first().offset().top,c=[];a.each(function(a){var d=b(this).offset().top;d>k&&(k=d,c.push(a))});0===c.length&&c.push(a.length-1);var n=[],f=0,l="";a.each(function(a){if(a<c[f])l+=this.textContent+" ";else{if(0<f&&f>=c.length)return!1;console.log(l);n.push(l.substring(0,l.length-1).replace(/(\t|\n)/g, ""));l=(this.innerText||this.textContent)+" ";f++}});for(var a=[],g=0,h=0,d=n.length;h<d;h++)a.push(n[h].length),g+=n[h].length;for(var e=0,h=0,d=a.length;h<d;h++)e+=a[h];h=Math.min.apply(null,a);d=Math.max.apply(null,a);return{measures:a,lines:a.length,average:(e/a.length).toPrecision(4),min:h,max:d,sum:e,signs:g}},v=function(a,c){if(!window.getMatchedCSSRules)return b(a).css(c);var d=a.style.getPropertyValue(c);if(a.style.getPropertyPriority(c))return d;for(var f=getMatchedCSSRules(a),g=f.length;0< g--;){var l=f[g],e=l.style.getPropertyPriority(c);if(null==d||e)if(d=l.style.getPropertyValue(c),e)break}return d||b(a).css(c)},x=function(a){a=C.apply(a);c.find("span.tm-average").html(a.average);c.find("span.tm-min").html(a.min);c.find("span.tm-max").html(a.max);c.find("span.tm-signs").html(a.signs)},y=function(a){d.css({top:a.pageY+5,left:a.pageX+5})},D=function(a){c.css({top:a.pageY-z,left:a.pageX-A})},E=function(a){t||(d.show(),b(this).on("mousemove",y),a=C.apply(this),d.html("average: "+a.average+ "<br />min: "+a.min+" \u2014 max: "+a.max))},F=function(a){d.hide();b(this).off("mousemove",y)},G=function(a){if(m!=this){var k=b(this);c.show();c.css({top:k.offset().top,left:k.offset().left+k.width()});t=!0;m=this;d.hide();b(this).off("mousemove",y);x(this);b("#tm-fontsize").val(v(this,"font-size"));b("#tm-lineheight").val(v(this,"line-height"));b("#tm-wordspacing").val(v(this,"word-spacing"));b("#tm-letterspacing").val(v(this,"letter-spacing"));a.stopPropagation()}};B.mousedown(function(a){var d= c.offset();z=a.pageY-d.top;A=a.pageX-d.left;b(document).on("mousemove",D)}).mouseup(function(){b(document).off("mousemove",D)});q.on("input",function(){var a=this.value.match(/(\d(\.)?)+/g);a&&this.value.substring(0,a[0].length).match(/\.$/)||(b(m).css(this.getAttribute("data-prop"),this.value),x(m))}).on("keydown",function(a){if((40===a.which||38===a.which)&&this.value.match(/-?(\d+)?\.?\d+.?/)){var c=this.value.split(/[^0-9]+$/)[0],d=c.indexOf("."),f=0<=d,g=this.value.substring(c.length),e=f?parseFloat(c): parseInt(c);a=38===a.which?1:-1;f&&(a*=0.1);e=f?(e+a).toFixed(c.length-d-1):e+a;c=this.getAttribute("data-prop");b(m).css(c,e.toString()+g);b(this).val(e.toString()+g);x(m)}});var I=function(a){27==a.which&&H()},J=function(a){!t||(p.has(a.target).length||p.is(a.target)||c.has(a.target).length||c.is(a.target))||(m=null,t=!1,c.hide())},H=function(){b("span."+w).each(function(){b(this.childNodes).unwrap()});p.off("mouseenter",E).off("mouseleave",F).off("click",G);b(document).off("keyup",I).off("click", J);d.remove();c.remove();s.remove()};p.hover(E,F);p.click(G);b(document).on("keyup",I).on("click",J);s.on("click",H)})})(jQuery);