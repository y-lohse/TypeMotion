$(function(){var m=$("p"),r=!1,h=null,x=0,y=0,n={position:"absolute",margin:0,padding:"10px",background:"#242424",border:"1px solid rgba(255,255,255,.3)","border-radius":"10px",padding:"10px 15px",color:"#fff","font-size":"18px","font-family":"tahoma","z-index:":15E3},s={"font-size":"18px","font-weight":"normal",padding:0,"margin-top":"25px",color:"#fff","margin-bottom":"5px"},c={padding:0,margin:0,"list-style":"none","font-size":"15px"},e=$("<div>");e.css($.extend({},n,{"text-align":"center"})); e.hide();var b=$("<div>");b.css(n);var z=$("<h1>").html("TypeMotion").css({"font-weight":"normal","font-size":"26px",margin:"0 0 10px",cursor:"move",color:"#fff",display:"inline-block"}),d=$("<h2>").html("Measure").css($.extend({},s,{"margin-top":0})),s=$("<h2>").html("Vertical Rythm").css(s);b.append(z).append(d);var d=$("<li>").css({"margin-bottom":"3px"}),p=$("<ul>").css(c);p.append(d.clone().html('<label>Average :</label> <span class="tm-average"></span>'));p.append(d.clone().html('<label>Minimum :</label> <span class="tm-min"></span>')); p.append(d.clone().html('<label>Maximum :</label> <span class="tm-max"></span>'));p.append(d.clone().html('<label>Total signs :</label> <span class="tm-signs"></span>'));b.append(p);c=$("<ul>").css(c);c.append(d.clone().html('<label for="tm-fontsize">Font size :</label><input id="tm-fontsize" data-prop="font-size" type="text" />'));c.append(d.clone().html('<label for="tm-lineheight">Line height :</label><input id="tm-lineheight" data-prop="line-height" type="text" />'));c.append(d.clone().html('<label for="tm-wordspacing">Word spacing :</label><input id="tm-wordspacing" data-prop="word-spacing" type="text" />')); c.append(d.clone().html('<label for="tm-letterspacing">Letter spacing :</label><input id="tm-letterspacing" data-prop="letter-spacing" type="text" />'));b.append(s);b.append(c);b.find("label").css({"min-width":"100px",display:"inline-block",color:"#fff"});b.hide();var q=$("<div>");q.css($.extend({},n,{position:"fixed",top:10,right:10,cursor:"pointer","text-align":"center"}));q.html("Exit TypeMotion");$("body").append(e).append(q).append(b);n=$("#tm-fontsize, #tm-lineheight, #tm-wordspacing, #tm-letterspacing"); n.css({width:"70px","text-align":"right","margin-left":"20px","margin-right":"5px",padding:"6px 4px",color:"#fff",background:"rgba(0,0,0,.8)",border:"1px solid #222","border-radius":"4px"});$.fn.spanify=function(a){this.each(function(){if(3===this.nodeType){var f=$("<div>");$.each(this.data.split(/\s/),function(b,l){l.length&&f.append($(a).clone().text(l+" "))});$(this).after(f.html()).remove()}else $(this.childNodes).spanify(a)})};var u="tm"+(new Date).getTime();m.spanify($("<span>").addClass(u)); var A=function(){var a=$(this);escape(a.text());var a=a.find("span."+u),f=a.first().offset().top,b=[];a.each(function(a){var c=$(this).offset().top;c>f&&(f=c,b.push(a))});var l=[],d=0,g="";a.each(function(a){if(a<b[d])g+=this.textContent+" ";else{if(d>=b.length)return!1;l.push(g.substring(0,g.length-1).replace(/(\t|\n)/g,""));g=(this.innerText||this.textContent)+" ";d++}});for(var a=[],e=0,k=0,c=l.length;k<c;k++)a.push(l[k].length),e+=l[k].length;for(var h=0,k=0,c=a.length;k<c;k++)h+=a[k];k=Math.min.apply(null, a);c=Math.max.apply(null,a);return{measures:a,lines:a.length,average:(h/a.length).toPrecision(4),min:k,max:c,sum:h,signs:e}},t=function(a,f){if(!window.getMatchedCSSRules)return $(a).css(f);var b=a.style.getPropertyValue(f);if(a.style.getPropertyPriority(f))return b;for(var c=getMatchedCSSRules(a),d=c.length;0<d--;){var g=c[d],e=g.style.getPropertyPriority(f);if(null==b||e)if(b=g.style.getPropertyValue(f),e)break}return b||$(a).css(f)},v=function(a){a=A.apply(a);b.find("span.tm-average").html(a.average); b.find("span.tm-min").html(a.min);b.find("span.tm-max").html(a.max);b.find("span.tm-signs").html(a.signs)},w=function(a){e.css({top:a.pageY+5,left:a.pageX+5})},B=function(a){b.css({top:a.pageY-x,left:a.pageX-y})},C=function(a){r||(e.show(),$(this).on("mousemove",w),a=A.apply(this),e.html("average: "+a.average+"<br />min: "+a.min+" \u2014 max: "+a.max))},D=function(a){e.hide();$(this).off("mousemove",w)},E=function(a){if(h!=this){var f=$(this);b.show();b.css({top:f.offset().top,left:f.offset().left+ f.width()});r=!0;h=this;e.hide();$(this).off("mousemove",w);v(this);$("#tm-fontsize").val(t(this,"font-size"));$("#tm-lineheight").val(t(this,"line-height"));$("#tm-wordspacing").val(t(this,"word-spacing"));$("#tm-letterspacing").val(t(this,"letter-spacing"));a.stopPropagation()}};z.mousedown(function(a){var f=b.offset();x=a.pageY-f.top;y=a.pageX-f.left;$(document).on("mousemove",B)}).mouseup(function(){$(document).off("mousemove",B)});n.on("input",function(){var a=this.value.match(/(\d(\.)?)+/g); a&&this.value.substring(0,a[0].length).match(/\.$/)||($(h).css(this.getAttribute("data-prop"),this.value),v(h))}).on("keydown",function(a){if((40===a.which||38===a.which)&&this.value.match(/-?(\d+)?\.?\d+.?/)){var b=this.value.split(/[^0-9]+$/)[0],c=b.indexOf("."),d=0<=c,e=this.value.substring(b.length),g=d?parseFloat(b):parseInt(b);a=38===a.which?1:-1;d&&(a*=0.1);g=d?(g+a).toFixed(b.length-c-1):g+a;b=this.getAttribute("data-prop");$(h).css(b,g.toString()+e);$(this).val(g.toString()+e);v(h)}});var G= function(a){27==a.which&&F()},H=function(a){!r||(m.has(a.target).length||m.is(a.target)||b.has(a.target).length||b.is(a.target))||(h=null,r=!1,b.hide())},F=function(){$("span."+u).each(function(){$(this.childNodes).unwrap()});m.off("mouseenter",C).off("mouseleave",D).off("click",E);$(document).off("keyup",G).off("click",H);e.remove();b.remove();q.remove()};m.hover(C,D);m.click(E);$(document).on("keyup",G).on("click",H);q.on("click",F)});