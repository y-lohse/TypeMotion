(function(b){b(function(){var m=b("p"),s=!1,g=null,y=0,z=0,n={position:"absolute",margin:0,padding:"10px",background:"#242424",border:"1px solid rgba(255,255,255,.3)","border-radius":"10px",padding:"10px 15px",color:"#fff","font-size":"18px","font-family":"tahoma","z-index:":15E3},t={"font-size":"18px","font-weight":"normal",padding:0,"margin-top":"25px",color:"#fff","margin-bottom":"5px"},e={padding:0,margin:0,"list-style":"none","font-size":"15px"},f=b("<div>");f.css(b.extend({},n,{"text-align":"center"})); f.hide();var c=b("<div>");c.css(n);var A=b("<h1>").html("TypeMotion").css({"font-weight":"normal","font-size":"26px",margin:"0 0 10px",cursor:"move",color:"#fff",display:"inline-block"}),d=b("<h2>").html("Measure").css(b.extend({},t,{"margin-top":0})),t=b("<h2>").html("Vertical Rythm").css(t);c.append(A).append(d);var d=b("<li>").css({"margin-bottom":"3px","list-style":"none"}),p=b("<ul>").css(e);p.append(d.clone().html('<label>Average :</label> <span class="tm-average"></span>'));p.append(d.clone().html('<label>Minimum :</label> <span class="tm-min"></span>')); p.append(d.clone().html('<label>Maximum :</label> <span class="tm-max"></span>'));p.append(d.clone().html('<label>Total signs :</label> <span class="tm-signs"></span>'));c.append(p);e=b("<ul>").css(e);e.append(d.clone().html('<label for="tm-fontsize">Font size :</label><input id="tm-fontsize" data-prop="font-size" type="text" />'));e.append(d.clone().html('<label for="tm-lineheight">Line height :</label><input id="tm-lineheight" data-prop="line-height" type="text" />'));e.append(d.clone().html('<label for="tm-wordspacing">Word spacing :</label><input id="tm-wordspacing" data-prop="word-spacing" type="text" />')); e.append(d.clone().html('<label for="tm-letterspacing">Letter spacing :</label><input id="tm-letterspacing" data-prop="letter-spacing" type="text" />'));c.append(t);c.append(e);c.find("label").css({"min-width":"100px",display:"inline-block",color:"#fff"});c.hide();var q=b("<div>");q.css(b.extend({},n,{position:"fixed",top:10,right:10,cursor:"pointer","text-align":"center"}));q.html("Exit TypeMotion");b("body").append(f).append(q).append(c);n=b("#tm-fontsize, #tm-lineheight, #tm-wordspacing, #tm-letterspacing"); n.css({width:"70px","text-align":"right","margin-left":"20px","margin-right":"5px",padding:"6px 4px",color:"#fff",background:"rgba(0,0,0,.8)",border:"1px solid #222","border-radius":"4px"});b.fn.spanify=function(a){this.each(function(){if(3===this.nodeType){var r=b("<div>");b.each(this.data.split(/\s/),function(c,l){l.length&&r.append(b(a).clone().text(l+" "))});b(this).after(r.html()).remove()}else b(this.childNodes).spanify(a)})};var v="tm"+(new Date).getTime();m.spanify(b("<span>").addClass(v)); var B=function(){var a=b(this);escape(a.text());var a=a.find("span."+v),r=a.first().offset().top,c=[];a.each(function(a){var d=b(this).offset().top;d>r&&(r=d,c.push(a))});0===c.length&&c.push(a.length-1);var l=[],d=0,h="";a.each(function(a){if(a<c[d])h+=this.textContent+" ";else{if(0<d&&d>=c.length)return!1;console.log(h);l.push(h.substring(0,h.length-1).replace(/(\t|\n)/g,""));h=(this.innerText||this.textContent)+" ";d++}});for(var a=[],f=0,k=0,e=l.length;k<e;k++)a.push(l[k].length),f+=l[k].length; for(var g=0,k=0,e=a.length;k<e;k++)g+=a[k];k=Math.min.apply(null,a);e=Math.max.apply(null,a);return{measures:a,lines:a.length,average:(g/a.length).toPrecision(4),min:k,max:e,sum:g,signs:f}},u=function(a,c){if(!window.getMatchedCSSRules)return b(a).css(c);var d=a.style.getPropertyValue(c);if(a.style.getPropertyPriority(c))return d;for(var e=getMatchedCSSRules(a),f=e.length;0<f--;){var h=e[f],g=h.style.getPropertyPriority(c);if(null==d||g)if(d=h.style.getPropertyValue(c),g)break}return d||b(a).css(c)}, w=function(a){a=B.apply(a);c.find("span.tm-average").html(a.average);c.find("span.tm-min").html(a.min);c.find("span.tm-max").html(a.max);c.find("span.tm-signs").html(a.signs)},x=function(a){f.css({top:a.pageY+5,left:a.pageX+5})},C=function(a){c.css({top:a.pageY-y,left:a.pageX-z})},D=function(a){s||(f.show(),b(this).on("mousemove",x),a=B.apply(this),f.html("average: "+a.average+"<br />min: "+a.min+" \u2014 max: "+a.max))},E=function(a){f.hide();b(this).off("mousemove",x)},F=function(a){if(g!=this){var d= b(this);c.show();c.css({top:d.offset().top,left:d.offset().left+d.width()});s=!0;g=this;f.hide();b(this).off("mousemove",x);w(this);b("#tm-fontsize").val(u(this,"font-size"));b("#tm-lineheight").val(u(this,"line-height"));b("#tm-wordspacing").val(u(this,"word-spacing"));b("#tm-letterspacing").val(u(this,"letter-spacing"));a.stopPropagation()}};A.mousedown(function(a){var d=c.offset();y=a.pageY-d.top;z=a.pageX-d.left;b(document).on("mousemove",C)}).mouseup(function(){b(document).off("mousemove",C)}); n.on("input",function(){var a=this.value.match(/(\d(\.)?)+/g);a&&this.value.substring(0,a[0].length).match(/\.$/)||(b(g).css(this.getAttribute("data-prop"),this.value),w(g))}).on("keydown",function(a){if((40===a.which||38===a.which)&&this.value.match(/-?(\d+)?\.?\d+.?/)){var c=this.value.split(/[^0-9]+$/)[0],d=c.indexOf("."),e=0<=d,f=this.value.substring(c.length),h=e?parseFloat(c):parseInt(c);a=38===a.which?1:-1;e&&(a*=0.1);h=e?(h+a).toFixed(c.length-d-1):h+a;c=this.getAttribute("data-prop");b(g).css(c, h.toString()+f);b(this).val(h.toString()+f);w(g)}});var H=function(a){27==a.which&&G()},I=function(a){!s||(m.has(a.target).length||m.is(a.target)||c.has(a.target).length||c.is(a.target))||(g=null,s=!1,c.hide())},G=function(){b("span."+v).each(function(){b(this.childNodes).unwrap()});m.off("mouseenter",D).off("mouseleave",E).off("click",F);b(document).off("keyup",H).off("click",I);f.remove();c.remove();q.remove()};m.hover(D,E);m.click(F);b(document).on("keyup",H).on("click",I);q.on("click",G)})})(jQuery);